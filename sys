#!/bin/bash

HOST="$1"
sharedDir=""
package_files=""
services=""
sync_dirs=""

if [ -z "$HOST" ]; then
    echo "No host defined"
    exit 1
fi

echoerr() { printf "%s\n" "$*" >&2; }

setVars() {
    sharedDir=$1
    package_files="$sharedDir/pkgs"
    services="$sharedDir/services"
    # sync dirs must have trailing /
    sync_dirs="$sharedDir/system/"
    if [ -d "./$HOST" ]; then
        package_files+=" ./$HOST/pkgs"
        services+=" ./$HOST/services"
        # sync dirs must have trailing /
        sync_dirs+=" ./$HOST/system/"
    fi
}


install_packages() {
    for pkgs in $package_files; do
        if [ -f "$pkgs" ]; then
            sudo dnf install --assumeyes $(cat "$pkgs")
        fi
    done
}

enable_services() {
    for svc_file in $services; do
        if [ -f "$svc_file" ]; then
            for svc in $(cat $svc_file); do
                sudo systemctl enable "$svc"
            done;
        fi
    done
}

sync_files() {
    for dir in $sync_dirs; do
        if [ -d "$dir" ]; then
            sudo rsync -rv "$dir" /
        fi
    done
}

add_rpmfusion() {
    sudo dnf install https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm https://mirrors.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm
}

desktop() {
    add_rpmfusion
    sudo dnf update --assumeyes --refresh
    install_packages
    sync_files
    enable_services
}

server() {
    sudo dnf update --assumeyes --refresh
    install_packages
    # Remove network connections as we only want ours there
    sudo rm /etc/NetworkManager/system-connections/*
    sync_files
    # Set appropriate permissions for network
    sudo chmod 0600 /etc/NetworkManager/system-connections/*
    enable_services
    sudo grub2-mkconfig -o /boot/efi/EFI/fedora/grub.cfg
}

addT480Partitions() {
    mkdir -p /mnt/storage
    mkdir -p /mnt/snapshots
    mkdir -p /mnt/git
    if ! grep /mnt/storage /etc/fstab; then
        echo "UUID=3c714e43-7a49-439c-8280-47b069806b97 /mnt/storage btrfs rw,relatime,compress=zstd,ssd,space_cache,subvol=@storage 0 0" | sudo tee -a /etc/fstab
    fi
    if ! grep /mnt/snapshots /etc/fstab; then
        echo "UUID=3c714e43-7a49-439c-8280-47b069806b97 /mnt/snapshots btrfs rw,relatime,compress=zstd,ssd,space_cache,subvol=@snapshots 0 0" | sudo tee -a /etc/fstab
    fi
    if ! grep /mnt/git /etc/fstab; then
        echo "UUID=3c714e43-7a49-439c-8280-47b069806b97 /mnt/snapshots btrfs rw,relatime,compress=zstd,ssd,space_cache,subvol=@git 0 0" | sudo tee -a /etc/fstab
    fi
}

case $HOST in
    t480)
        setVars "./shared_server"
        server
        addT480Partitions
        ;;
    razorbook)
        setVars "./shared_desktop"
        desktop
        ;;
    ultra24)
        setVars "./shared_desktop"
        desktop
        ;;
esac

